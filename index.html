<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>纯净B站</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --bili-blue: #00aeec; --bg-gray: #f6f7f8; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; padding: 20px; background: #fff; color: #18191c; }
        
        .search-container { position: sticky; top: 0; background: #fff; padding-bottom: 10px; z-index: 10; }
        input { 
            width: 100%; padding: 12px 15px; border: 2px solid var(--bg-gray); 
            border-radius: 12px; font-size: 16px; outline: none; box-sizing: border-box;
            transition: border-color 0.3s;
        }
        input:focus { border-color: var(--bili-blue); }

        .section-title { font-size: 12px; color: #9499a0; margin: 20px 0 10px; font-weight: bold; display: flex; justify-content: space-between; }
        .tag-container { display: flex; flex-wrap: wrap; gap: 10px; }
        
        /* 针对触控优化的标签：更大，间距更合理 */
        .tag { 
            padding: 10px 18px; background: var(--bg-gray); border-radius: 8px; 
            font-size: 14px; cursor: pointer; -webkit-tap-highlight-color: transparent;
        }
        .tag:active { background: #e3e5e7; transform: scale(0.95); }
        
        .btn-manage { color: var(--bili-blue); font-size: 12px; cursor: pointer; }
    </style>
</head>
<body>

<div class="search-container">
    <input type="text" id="searchInput" placeholder="搜点高质量的内容...">
</div>

<div id="app">
    </div>

<script>
    // 注册 Service Worker
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js');
    }

    const DEFAULT_WORDS = ['逻辑学', '古典艺术', 'Flutter 进阶', '纪录片'];
    const MAX_HISTORY = 6;
    const PROMOTION_THRESHOLD = 10;

    // 数据操作逻辑
    const getStaticWords = () => JSON.parse(localStorage.getItem('my_static_search_words') || JSON.stringify(DEFAULT_WORDS));
    const saveStaticWords = (words) => localStorage.setItem('my_static_search_words', JSON.stringify(words));

    const recordSearch = (word) => {
        if (!word) return;
        const data = JSON.parse(localStorage.getItem('my_search_stats') || '{}');
        data[word] = (data[word] || 0) + 1;
        localStorage.setItem('my_search_stats', JSON.stringify(data));
        
        // 智能晋升：手机上直接静默检查
        const staticWords = getStaticWords();
        if (data[word] >= PROMOTION_THRESHOLD && !staticWords.includes(word)) {
            if (confirm(`“${word}”已搜索多次，是否固定？`)) {
                staticWords.push(word);
                saveStaticWords(staticWords);
                render();
            }
        }
    };

    function doSearch(word) {
        if (!word) return;
        recordSearch(word);
        // 跳转到移动端 B 站结果页
        window.location.href = `https://m.bilibili.com/search?keyword=${encodeURIComponent(word)}`;
    }

    function render() {
        const history = Object.entries(JSON.parse(localStorage.getItem('my_search_stats') || '{}'))
            .sort((a, b) => b[1] - a[1]).slice(0, MAX_HISTORY).map(i => i[0]);
        const statics = getStaticWords();

        document.getElementById('app').innerHTML = `
            <div class="section-title"><span>高频记忆</span></div>
            <div class="tag-container">${history.map(w => `<div class="tag">${w}</div>`).join('')}</div>
            
            <div class="section-title">
                <span>常用导航</span>
                <span class="btn-manage" onclick="addWord()">+新增</span>
            </div>
            <div class="tag-container">${statics.map(w => `<div class="tag">${w}</div>`).join('')}</div>
        `;
    }

    function addWord() {
        const w = prompt("输入关键词");
        if(w) { 
            const s = getStaticWords(); s.push(w); saveStaticWords(s); render(); 
        }
    }

    // 事件绑定
    document.getElementById('searchInput').addEventListener('keydown', (e) => {
        if(e.key === 'Enter') doSearch(e.target.value);
    });

    document.getElementById('app').addEventListener('click', (e) => {
        if(e.target.classList.contains('tag')) doSearch(e.target.innerText);
    });

    render();
</script>
</body>
</html>